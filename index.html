<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videostar - Creador de inserts</title>
    <link rel="icon" href="favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para manejar el arrastre de archivos */
        #drop-area {
            transition: all 0.3s ease;
            border: 2px dashed #9ca3af; /* gray-400 */
        }
        #drop-area.dragover {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        /* Clase para el fondo difuminado en el lienzo */
        .canvas-container {
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #000;
        }
        /* Estilos espec√≠ficos para el lienzo de video */
        #video-canvas {
            display: block;
            background-color: #000;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2"><img src="logo.png" alt="Videostar" style="margin:auto;display:block;width:300px;"></h1>
            <p class="text-gray-500">Inserts r√°pidos y f√°ciles</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-8">
                
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1Ô∏è‚É£ Cargar im√°genes</h2>

                    <div id="drop-area" class="p-6 text-center rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition duration-150 ease-in-out">
                        <p class="text-gray-500 mb-2">Arrastr√° y solt√°</p>
                        <p class="text-sm font-medium text-gray-400 mb-3">o</p>
                        <button onclick="document.getElementById('file-input').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                            Seleccionar archivos
                        </button>
                        <input type="file" id="file-input" accept="image/*" multiple class="hidden">
                    </div>

                    <div class="mt-4">
                        <label for="url-input" class="block text-sm font-medium text-gray-700 mb-1">A√±adir por URL (una por l√≠nea):</label>
                        <textarea id="url-input" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        <button id="load-url-btn" class="mt-2 w-full bg-blue-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-200">
                            Cargar URLs
                        </button>
                    </div>

                    <div id="image-list" class="mt-6 space-y-2">
                        <p class="text-sm text-gray-500 font-medium">Im√°genes cargadas (0):</p>
                    </div>
                    
                    <button id="clear-all-btn" class="mt-4 w-full bg-red-400 hover:bg-red-500 text-white font-bold py-2 rounded-lg shadow-md transition duration-200 disabled:opacity-50" disabled>
                        Limpiar todas las im√°genes
                    </button>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2Ô∏è‚É£ Configuraci√≥n</h2>

                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Formato:</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="aspect-ratio" value="16:9" checked class="form-radio h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Horizontal (16:9)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="aspect-ratio" value="9:16" class="form-radio h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Vertical (9:16)</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Efecto de animaci√≥n:</label>
                        <select id="effect-type" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="zoom">Zoom lento (Ken Burns)</option>
                            <option value="none">Sin animaci√≥n</option>
                        </select>
                    </div>
                    
                    <div id="zoom-settings" class="space-y-4">
                        <div class="mb-4">
                            <label for="slide-duration" class="block text-sm font-medium text-gray-700 mb-2">Duraci√≥n por diapositiva (segundos): <span id="duration-value" class="font-bold text-blue-600">5.0</span>s</label>
                            <input type="range" id="slide-duration" min="1.0" max="10.0" step="0.5" value="5.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="mb-4">
                            <label for="zoom-speed" class="block text-sm font-medium text-gray-700 mb-2">Velocidad del zoom (% de inicio a fin): <span id="zoom-value" class="font-bold text-blue-600">10</span>%</label>
                            <input type="range" id="zoom-speed" min="1" max="50" step="1" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-gray-500 mt-1">Define el porcentaje de cambio de escala durante la duraci√≥n de la diapositiva.</p>
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <label for="loop-count" class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de repeticiones (loops):</label>
                        <select id="loop-count" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="1">1 loop (sin repetir)</option>
                            <option value="2">2 loops</option>
                            <option value="3">3 loops</option>
                            <option value="4">4 loops</option>
                            <option value="5">5 loops</option>
                        </select>
                    </div>

                </section>
                
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">3Ô∏è‚É£ Generar y exportar</h2>
                    <div class="space-y-4">
                        <button id="preview-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50" disabled>
                            <span id="preview-text">Generar previsualizaci√≥n</span>
                        </button>
                        <button id="export-btn" class="w-full bg-blue-600 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50" disabled>
                            <span id="export-text">Exportar video</span>
                        </button>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 sticky top-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">üéûÔ∏è Previsualizaci√≥n del video</h2>
                    
                    <div id="canvas-wrapper" class="canvas-container w-full aspect-[16/9] transition-all duration-300">
                        <canvas id="video-canvas" class="rounded-lg"></canvas>
                        <div id="status-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center text-white text-lg font-medium rounded-lg">
                            Carg√° algunas im√°genes y presion√° "Generar previsualizaci√≥n"
                        </div>
                    </div>
                    
                    <div id="message-box" class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>
                </div>
            </div>

        </main>
        
        <footer class="mt-10 text-center text-sm text-gray-400">
            <p>Versi√≥n 1.5. Esta p√°gina es experimental y puede tener errores.</p>
        </footer>
    </div>

    <script type="module">
        // Variables globales
        let loadedImages = [];
        let currentImageIndex = 0;
        let previousImageIndex = 0; // Almacena el √≠ndice de la imagen anterior (ya no se usa para transiciones)
        let isPreviewing = false;
        let isRecording = false;
        let animationStartTime = 0;
        let animationFrameId = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let targetRecordingDuration = 0; 
        const TRANSITION_DURATION = 0.5; // Duraci√≥n fija de 0.5 segundos (se mantiene por si se reutiliza)
        
        // Elementos del DOM
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const urlInput = document.getElementById('url-input');
        const loadUrlBtn = document.getElementById('load-url-btn');
        const imageList = document.getElementById('image-list');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const canvas = document.getElementById('video-canvas');
        const ctx = canvas.getContext('2d');
        const previewBtn = document.getElementById('preview-btn');
        const exportBtn = document.getElementById('export-btn');
        const statusOverlay = document.getElementById('status-overlay');
        const messageBox = document.getElementById('message-box');
        const durationRange = document.getElementById('slide-duration');
        const zoomRange = document.getElementById('zoom-speed');
        const effectType = document.getElementById('effect-type');
        const loopCountSelect = document.getElementById('loop-count'); 
        const clearAllBtn = document.getElementById('clear-all-btn'); 

        // Configuraci√≥n inicial del Canvas
        const VIDEO_FPS = 30; // 30 cuadros por segundo
        const MAX_CANVAS_WIDTH = 1280; 
        const MAX_CANVAS_HEIGHT = 720; 

        // --- Utilidades de UI ---

        /** Muestra un mensaje en el cuadro de mensajes. */
        function showMessage(message, type = 'warning') {
            const classes = {
                'warning': 'bg-yellow-100 text-yellow-800',
                'error': 'bg-red-100 text-red-800',
                'success': 'bg-green-100 text-green-800'
            };
            messageBox.className = `mt-4 p-3 rounded-lg ${classes[type]}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');
        }

        /** Oculta el mensaje. */
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        /** Actualiza el estado de los botones y el overlay. */
        function updateUIState() {
            const hasImages = loadedImages.length > 0;
            
            // L√≥gica de deshabilitaci√≥n: No se puede previsualizar ni exportar si el otro est√° activo.
            previewBtn.disabled = !hasImages || isRecording;
            exportBtn.disabled = !hasImages || isPreviewing;
            clearAllBtn.disabled = !hasImages; // Habilitar/Deshabilitar bot√≥n de limpiar todo
            
            if (loadedImages.length === 0) {
                statusOverlay.textContent = 'Carg√° tus im√°genes y presion√° "Generar previsualizaci√≥n"';
                statusOverlay.classList.remove('hidden');
            } else if (isPreviewing) {
                statusOverlay.classList.add('hidden');
                previewBtn.textContent = 'Detener previsualizaci√≥n';
                exportBtn.disabled = true; 
            } else if (isRecording) {
                statusOverlay.textContent = 'üî¥ Grabando video...';
                statusOverlay.classList.remove('hidden');
                exportBtn.textContent = 'Detener grabaci√≥n'; 
                previewBtn.disabled = true; 
            } else {
                statusOverlay.classList.add('hidden');
                previewBtn.textContent = 'Generar previsualizaci√≥n';
                exportBtn.textContent = 'Exportar video';
            }
        }

        /** Dibuja la lista de im√°genes cargadas en el DOM. */
        function renderImageList() {
            imageList.innerHTML = `<p class="text-sm text-gray-500 font-medium">Im√°genes cargadas (${loadedImages.length}):</p>`;
            loadedImages.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg text-sm';
                item.innerHTML = `
                    <span class="truncate pr-2 text-gray-700">${index + 1}. ${img.src.split('/').pop() || 'Imagen cargada'}</span>
                    <button data-index="${index}" class="remove-img-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                imageList.appendChild(item);
            });

            document.querySelectorAll('.remove-img-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    loadedImages.splice(index, 1);
                    renderImageList();
                    updateUIState();
                });
            });
            updateCanvasDimensions(); 
        }

        // Limpia todas las im√°genes cargadas
        function clearAllImages() {
            loadedImages = [];
            renderImageList();
            updateUIState();
            drawInitialPlaceholder(); // Redibuja el placeholder
            stopPreview(); // Detiene cualquier previsualizaci√≥n activa
        }

        // --- L√≥gica de Carga de Im√°genes ---

        /** Carga una imagen dada su URL. */
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous"; 
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Error al cargar la imagen desde URL: ${url}`));
                img.src = url;
            });
        }

        /** Maneja la carga de archivos. */
        async function handleFiles(files) {
            hideMessage();
            if (files.length === 0) return;

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const url = URL.createObjectURL(file);
                    try {
                        const img = await loadImage(url);
                        loadedImages.push(img);
                        URL.revokeObjectURL(url); 
                    } catch (error) {
                        showMessage(`Error al cargar el archivo ${file.name}.`, 'error');
                        console.error(error);
                    }
                }
            }
            renderImageList();
            updateUIState();
        }

        /** Maneja la carga de URLs. */
        loadUrlBtn.addEventListener('click', async () => {
            const urls = urlInput.value.split('\n').map(url => url.trim()).filter(url => url);
            urlInput.value = '';
            hideMessage();

            for (const url of urls) {
                try {
                    const img = await loadImage(url);
                    loadedImages.push(img);
                } catch (error) {
                    showMessage(`No se pudo cargar la imagen desde: ${url}. Aseg√∫rate de que la URL sea p√∫blica y permita CORS.`, 'error');
                    console.error(error);
                }
            }
            renderImageList();
            updateUIState();
        });

        // Eventos de entrada de archivos
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // Eventos de Drag and Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
        });

        dropArea.addEventListener('drop', (e) => {
            let dt = e.dataTransfer;
            let files = dt.files;
            handleFiles(files);
        }, false);

        // --- L√≥gica de Canvas y Rendering ---

        /** Actualiza las dimensiones del canvas y del contenedor. */
        function updateCanvasDimensions() {
            const aspectRatio = document.querySelector('input[name="aspect-ratio"]:checked').value;
            let width, height;

            if (aspectRatio === '16:9') {
                width = MAX_CANVAS_WIDTH;
                height = (MAX_CANVAS_WIDTH * 9) / 16;
                canvasWrapper.classList.remove('aspect-[9/16]');
                canvasWrapper.classList.add('aspect-[16/9]');
            } else { // 9:16
                height = MAX_CANVAS_HEIGHT;
                width = (MAX_CANVAS_HEIGHT * 9) / 16;
                canvasWrapper.classList.remove('aspect-[16/9]');
                canvasWrapper.classList.add('aspect-[9/16]');
            }

            canvas.width = width;
            canvas.height = height;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
        }

        /** * Dibuja la imagen principal (ajuste "Contain") con zoom.
         * @param {Image} img - El objeto Image a dibujar.
         * @param {number} currentZoomScale - El factor de zoom a aplicar.
         */
        function drawContentImage(img, canvasW, canvasH, currentZoomScale = 1.0) {
            // Factor de escala base (Contain: ajusta la imagen para que quepa completamente)
            const scale = Math.min(canvasW / img.width, canvasH / img.height);
            const baseW = img.width * scale;
            const baseH = img.height * scale;

            // Aplicar la escala de zoom
            const drawW = baseW * currentZoomScale;
            const drawH = baseH * currentZoomScale;

            // Posicionamiento Centrado
            const drawX = (canvasW - drawW) / 2;
            const drawY = (canvasH - drawH) / 2;
            
            // NOTA DE CORRECCI√ìN: Se restaur√≥ el movimiento fluido de sub-p√≠xeles.
            // El fondo ampliado al 110% debe cubrir cualquier posible margen expuesto.

            ctx.drawImage(img, drawX, drawY, drawW, drawH);
        }
        
        /** * Calcula el factor de zoom para un momento dado de una diapositiva.
         * @param {number} time - El tiempo dentro de la diapositiva (0 a duration).
         * @param {number} duration - Duraci√≥n total de la diapositiva.
         * @param {number} zoomPercent - Porcentaje de zoom (0 a 1).
         * @returns {number} El factor de escala (e.g., 1.0 a 1.1).
         */
        function calculateZoomScale(time, duration, zoomPercent) {
            if (effectType.value !== 'zoom') return 1.0;
            const t = Math.min(time / duration, 1.0);
            return 1.0 + (zoomPercent * t);
        }

        /** Dibuja la imagen actual con el fondo difuminado y aplica el efecto de zoom.
         * @param {number} slideTime - Tiempo transcurrido desde el inicio de la diapositiva en segundos (0 to duration).
         * @param {boolean} forceStatic - Si es true, ignora la animaci√≥n.
         */
        function drawImage(slideTime, forceStatic = false) {
            if (loadedImages.length === 0) return;
            const img = loadedImages[currentImageIndex];
            const canvasW = canvas.width;
            const canvasH = canvas.height;
            const duration = parseFloat(durationRange.value);
            const zoomPercent = parseFloat(zoomRange.value) / 100;
            const effect = effectType.value;
            
            // 1. Limpiar el canvas
            ctx.clearRect(0, 0, canvasW, canvasH);
            
            // 2. Dibujar Fondo Difuminado (Gaussian Blur) con la imagen actual
            const imgRatio = img.width / img.height;
            const canvasRatio = canvasW / canvasH;
            
            let bgW, bgH, bgX, bgY;
            
            // L√≥gica de "Cover" para el fondo, escalado en un 1.1 (10% m√°s) para evitar m√°rgenes negros
            const scaleFactor = 1.1; 
            
            // La l√≥gica de cover garantiza que el fondo siempre cubra el canvas.
            if (imgRatio < canvasRatio) { 
                // Imagen m√°s alta que el canvas (vertical). Escalar por ancho del canvas.
                bgW = canvasW * scaleFactor;
                bgH = bgW / imgRatio;
            } else { 
                // Imagen m√°s ancha que el canvas (horizontal). Escalar por alto del canvas.
                bgH = canvasH * scaleFactor;
                bgW = imgRatio * bgH;
            }
            
            // Centrar el fondo escalado
            bgX = (canvasW - bgW) / 2;
            bgY = (canvasH - bgH) / 2;

            ctx.filter = 'blur(20px)';
            ctx.globalAlpha = 0.8; 
            ctx.drawImage(img, bgX, bgY, bgW, bgH);
            ctx.filter = 'none';
            ctx.globalAlpha = 1.0;

            // 3. Dibujar la Imagen Principal (Efecto "Contain" / Mostrar toda la imagen)
            
            // Calcular escala de zoom
            let currentZoomScale = 1.0;
            if (effect === 'zoom' && !forceStatic) {
                currentZoomScale = calculateZoomScale(slideTime, duration, zoomPercent);
            }
            
            // Dibujar imagen con zoom (restaurando la fluidez)
            drawContentImage(img, canvasW, canvasH, currentZoomScale);
        }

        // --- L√≥gica de Animaci√≥n y Control ---

        /** Bucle principal de animaci√≥n (Preview/Grabaci√≥n). */
        function animationLoop(timestamp) {
            if (!animationStartTime) {
                animationStartTime = timestamp;
            }

            // Tiempo transcurrido en el bucle (total) en segundos
            const elapsedLoopTime = (timestamp - animationStartTime) / 1000;
            const duration = parseFloat(durationRange.value);
            
            const numImages = loadedImages.length;
            if (numImages === 0) return;

            // Longitud total del video de un solo ciclo
            const singleCycleDuration = numImages * duration;

            // Tiempo total transcurrido dentro de un ciclo completo (maneja loops)
            const timeInCycle = elapsedLoopTime % singleCycleDuration;

            // √çndice de la imagen que deber√≠a estar visible en este punto del tiempo
            const indexInTime = Math.floor(timeInCycle / duration);

            // Gesti√≥n del estado de transici√≥n (Corte Seco)
            if (indexInTime !== currentImageIndex) {
                currentImageIndex = indexInTime; 
            }
            
            // Tiempo dentro de la diapositiva actual (0 a duration)
            const slideTime = timeInCycle % duration; 

            // Dibuja el frame actual
            drawImage(slideTime);

            // Detener grabaci√≥n autom√°ticamente si se alcanza la duraci√≥n objetivo
            if (isRecording && elapsedLoopTime >= targetRecordingDuration) {
                stopRecording();
                return;
            }

            if (isPreviewing || isRecording) {
                animationFrameId = requestAnimationFrame(animationLoop);
            }
        }
        
        /** Inicia la previsualizaci√≥n. */
        function startPreview() {
            if (loadedImages.length === 0) {
                showMessage("Por favor, carga al menos una imagen.", 'error');
                return;
            }
            if (isPreviewing) {
                stopPreview();
                return;
            }
            
            updateCanvasDimensions();
            currentImageIndex = 0;
            previousImageIndex = 0;
            animationStartTime = 0; 
            isPreviewing = true;
            updateUIState();
            
            animationFrameId = requestAnimationFrame(animationLoop);
        }

        /** Detiene la previsualizaci√≥n. */
        function stopPreview() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            isPreviewing = false;
            animationStartTime = 0;
            // Dibuja la primera imagen est√°ticamente
            drawImage(0, true); 
            updateUIState();
        }

        /** Inicia la grabaci√≥n del video. */
        function startRecording() {
            if (loadedImages.length === 0) {
                showMessage("Por favor, carga al menos una imagen para grabar.", 'error');
                return;
            }
            if (isRecording) {
                stopRecording();
                return;
            }
            
            // 1. Configuraci√≥n de Duraci√≥n
            updateCanvasDimensions();
            currentImageIndex = 0;
            previousImageIndex = 0;
            animationStartTime = 0;
            
            const loopCount = parseInt(loopCountSelect.value);
            const slideDuration = parseFloat(durationRange.value);
            const singleCycleDuration = loadedImages.length * slideDuration;
            targetRecordingDuration = singleCycleDuration * loopCount;

            isRecording = true;
            recordedChunks = [];
            updateUIState();
            hideMessage();
            // A√ëADIDO: Advertencia de permanencia en la pesta√±a.
            showMessage(`üî¥ Grabando ${loopCount} loop(s). Duraci√≥n total aproximada: ${targetRecordingDuration.toFixed(1)} segundos.
            <strong>Mantener esta pesta√±a abierta y visible durante la grabaci√≥n, de lo contrario la exportaci√≥n fallar√° o ser√° muy lenta.</strong>`, 'warning');

            // 2. Obtener el stream del canvas
            const stream = canvas.captureStream(VIDEO_FPS); 
            
            // FIX para evitar segundos en negro: dibujar el primer frame antes de inicializar MediaRecorder.
            // Esto asegura que el stream comience con la imagen correcta.
            drawImage(0, true);

            // 3. Inicializar MediaRecorder
            try {
                // Intentar usar VP9 para mejor calidad (si no, retrocede a VP8 est√°ndar)
                const options = { mimeType: 'video/webm; codecs=vp9' };
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                showMessage(`Codec vp9 no compatible. Usando WebM/VP8 est√°ndar. Error: ${e.message}`, 'warning');
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            }

            // 4. Manejar datos grabados
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            // 5. Manejar el evento de parada (finalizaci√≥n de la grabaci√≥n)
            mediaRecorder.onstop = () => {
                isRecording = false;
                updateUIState();
                
                const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const now = new Date().toISOString().replace(/[:.]/g, '-');
                // Nombre de archivo actualizado
                a.download = `videostar_insert_${now}.webm`;
                
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                showMessage("¬°Video exportado con √©xito! Revis√° tus descargas.", 'success');
            };

            // 6. Iniciar la grabaci√≥n
            // Iniciar MediaRecorder con un peque√±o intervalo para forzar la recolecci√≥n de datos
            mediaRecorder.start(1000 / VIDEO_FPS); 
            
            // 7. Iniciar el bucle de animaci√≥n para alimentar el canvas
            animationFrameId = requestAnimationFrame(animationLoop);
        }

        /** Detiene la grabaci√≥n del video. */
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                cancelAnimationFrame(animationFrameId);
                mediaRecorder.stop();
            }
        }

        // --- Event Listeners Globales ---

        // Bot√≥n de Previsualizaci√≥n
        previewBtn.addEventListener('click', startPreview);
        
        // Bot√≥n de Exportaci√≥n
        exportBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // Bot√≥n de Limpiar Todo
        clearAllBtn.addEventListener('click', clearAllImages); // Listener para el bot√≥n

        // Controles de configuraci√≥n
        document.querySelectorAll('input[name="aspect-ratio"]').forEach(input => {
            input.addEventListener('change', updateCanvasDimensions);
        });

        durationRange.addEventListener('input', () => {
            document.getElementById('duration-value').textContent = durationRange.value;
        });

        zoomRange.addEventListener('input', () => {
            document.getElementById('zoom-value').textContent = zoomRange.value;
        });
        
        // Inicializaci√≥n al cargar la p√°gina
        window.onload = () => {
            updateCanvasDimensions();
            updateUIState();
        };

        // Dibuja una imagen de inicio para que el canvas no est√© vac√≠o.
        function drawInitialPlaceholder() {
            ctx.fillStyle = '#1f2937'; // gray-800
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#9ca3af'; // gray-400
            ctx.font = '20px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Videostar - Generador de Slideshow', canvas.width / 2, canvas.height / 2);
        }
        
        // Inicializar el placeholder al cargar
        window.addEventListener('load', () => {
            updateCanvasDimensions();
            drawInitialPlaceholder();
        });

    </script>
</body>

</html>